



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-3.3.0">
    
    
      
        <title>Task Execution - My learning notes</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.572ca0f0.css">
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../../../../assets/javascripts/modernizr.962652e9.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#6-task-execution" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../.." title="My learning notes" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                My learning notes
              </span>
              <span class="md-header-nav__topic">
                Task Execution
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../.." title="My learning notes" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    My learning notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Architecture
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      Microservices Patterns
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        Microservices Patterns
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../architecture/microservices-patterns/escaping-monolithic-hell/" title="Escaping monolithic hell" class="md-nav__link">
      Escaping monolithic hell
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Artificial Intelligence
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Artificial Intelligence
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1">
    
    <label class="md-nav__link" for="nav-3-1">
      Machine Leatning
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        Machine Leatning
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../artificial-intelligence/machine-learning/introduction/intro/" title="Intro" class="md-nav__link">
      Intro
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../artificial-intelligence/machine-learning/introduction/supervised-learning/" title="Supervised Learning" class="md-nav__link">
      Supervised Learning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../artificial-intelligence/machine-learning/introduction/unsupervised-learning/" title="Unsupervised Learning" class="md-nav__link">
      Unsupervised Learning
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      Data science
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Data science
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2-1" type="checkbox" id="nav-3-2-1">
    
    <label class="md-nav__link" for="nav-3-2-1">
      Statistical learning
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-2-1">
        Statistical learning
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../artificial-intelligence/data-science/statistical-learning/introduction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Java
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Java
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1" checked>
    
    <label class="md-nav__link" for="nav-4-1">
      Concurrency
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        Concurrency
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../introduction/c01-intro/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fundamentals/c02-thread-safety/" title="Thread safety" class="md-nav__link">
      Thread safety
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fundamentals/c03-sharing-objects/" title="Sharing objects" class="md-nav__link">
      Sharing objects
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fundamentals/c04-composing-objects/" title="Composing objects" class="md-nav__link">
      Composing objects
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fundamentals/c05-building-blocks/" title="Building blocks" class="md-nav__link">
      Building blocks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fundamentals/summary/" title="Summary Part I" class="md-nav__link">
      Summary Part I
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Task Execution
      </label>
    
    <a href="./" title="Task Execution" class="md-nav__link md-nav__link--active">
      Task Execution
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#executing-tasks-in-threads" title="Executing tasks in threads" class="md-nav__link">
    Executing tasks in threads
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#executing-tasks-sequentially" title="Executing tasks sequentially" class="md-nav__link">
    Executing tasks sequentially
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicitly-creating-threads-for-tasks" title="Explicitly creating threads for tasks" class="md-nav__link">
    Explicitly creating threads for tasks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disadvantages-of-unbounded-thread-creation" title="Disadvantages of unbounded thread creation" class="md-nav__link">
    Disadvantages of unbounded thread creation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-executor-framework" title="The Executor framework" class="md-nav__link">
    The Executor framework
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-web-server-using-executor" title="Example: web server using Executor" class="md-nav__link">
    Example: web server using Executor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-policies" title="Execution policies" class="md-nav__link">
    Execution policies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-pools" title="Thread pools" class="md-nav__link">
    Thread pools
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executor-lifecycle" title="Executor lifecycle" class="md-nav__link">
    Executor lifecycle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delayed-and-periodic-tasks" title="Delayed and periodic tasks" class="md-nav__link">
    Delayed and periodic tasks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#finding-exploitable-parallelism" title="Finding exploitable parallelism" class="md-nav__link">
    Finding exploitable parallelism
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-sequential-page-renderer" title="Example: sequential page renderer" class="md-nav__link">
    Example: sequential page renderer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#result-bearing-tasks-callable-and-future" title="Result-bearing tasks: Callable and Future" class="md-nav__link">
    Result-bearing tasks: Callable and Future
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-page-renderer-with-future" title="Example: page renderer with Future" class="md-nav__link">
    Example: page renderer with Future
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limitations-of-parallelizing-heterogeneous-tasks" title="Limitations of parallelizing heterogeneous tasks" class="md-nav__link">
    Limitations of parallelizing heterogeneous tasks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#completionservice-executor-meets-blockingqueue" title="CompletionService: Executor meets BlockingQueue" class="md-nav__link">
    CompletionService: Executor meets BlockingQueue
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-page-renderer-with-completionservice" title="Example: page renderer with CompletionService" class="md-nav__link">
    Example: page renderer with CompletionService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#placing-time-limits-on-tasks" title="Placing time limits on tasks" class="md-nav__link">
    Placing time limits on tasks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-a-travel-reservations-portal" title="Example: a travel reservations portal" class="md-nav__link">
    Example: a travel reservations portal
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../c07-cancellation-and-shutdown/" title="Cancellation and Shutdown" class="md-nav__link">
      Cancellation and Shutdown
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../c08-applying-thread-pools/" title="Applying Thread Pools" class="md-nav__link">
      Applying Thread Pools
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Git
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Git
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1">
    
    <label class="md-nav__link" for="nav-5-1">
      Useful commands
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        Useful commands
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../git/useful-commands/stash/" title="Stash" class="md-nav__link">
      Stash
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Interviews
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Interviews
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-1" type="checkbox" id="nav-6-1">
    
    <label class="md-nav__link" for="nav-6-1">
      programming-interviews-exposed
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-1">
        programming-interviews-exposed
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../interviews/programming-interviews-exposed/04-approaches-to-programming-problems/" title="Approaches-to-programming-problems" class="md-nav__link">
      Approaches-to-programming-problems
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Consulting
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Consulting
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-1" type="checkbox" id="nav-7-1">
    
    <label class="md-nav__link" for="nav-7-1">
      Pedro Conchas
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-1">
        Pedro Conchas
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../consulting/pconchas/01_caso/" title="Car Shop " class="md-nav__link">
      Car Shop 
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#executing-tasks-in-threads" title="Executing tasks in threads" class="md-nav__link">
    Executing tasks in threads
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#executing-tasks-sequentially" title="Executing tasks sequentially" class="md-nav__link">
    Executing tasks sequentially
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicitly-creating-threads-for-tasks" title="Explicitly creating threads for tasks" class="md-nav__link">
    Explicitly creating threads for tasks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disadvantages-of-unbounded-thread-creation" title="Disadvantages of unbounded thread creation" class="md-nav__link">
    Disadvantages of unbounded thread creation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-executor-framework" title="The Executor framework" class="md-nav__link">
    The Executor framework
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-web-server-using-executor" title="Example: web server using Executor" class="md-nav__link">
    Example: web server using Executor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-policies" title="Execution policies" class="md-nav__link">
    Execution policies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-pools" title="Thread pools" class="md-nav__link">
    Thread pools
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executor-lifecycle" title="Executor lifecycle" class="md-nav__link">
    Executor lifecycle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delayed-and-periodic-tasks" title="Delayed and periodic tasks" class="md-nav__link">
    Delayed and periodic tasks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#finding-exploitable-parallelism" title="Finding exploitable parallelism" class="md-nav__link">
    Finding exploitable parallelism
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-sequential-page-renderer" title="Example: sequential page renderer" class="md-nav__link">
    Example: sequential page renderer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#result-bearing-tasks-callable-and-future" title="Result-bearing tasks: Callable and Future" class="md-nav__link">
    Result-bearing tasks: Callable and Future
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-page-renderer-with-future" title="Example: page renderer with Future" class="md-nav__link">
    Example: page renderer with Future
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limitations-of-parallelizing-heterogeneous-tasks" title="Limitations of parallelizing heterogeneous tasks" class="md-nav__link">
    Limitations of parallelizing heterogeneous tasks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#completionservice-executor-meets-blockingqueue" title="CompletionService: Executor meets BlockingQueue" class="md-nav__link">
    CompletionService: Executor meets BlockingQueue
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-page-renderer-with-completionservice" title="Example: page renderer with CompletionService" class="md-nav__link">
    Example: page renderer with CompletionService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#placing-time-limits-on-tasks" title="Placing time limits on tasks" class="md-nav__link">
    Placing time limits on tasks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-a-travel-reservations-portal" title="Example: a travel reservations portal" class="md-nav__link">
    Example: a travel reservations portal
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="6-task-execution">6. Task Execution</h1>
<p>Most concurrent applications are organized around the execution of <em><strong>tasks: abstract, discrete units of work.</strong></em> Dividing the work of an application into tasks simplifies program organization, facilitates error recovery by providing natural transaction boundaries, and promotes concurrency by providing a natural structure for parallelizing work.</p>
<h2 id="executing-tasks-in-threads">Executing tasks in threads</h2>
<p>The first step in organizing a program around task execution is identifying sensible task boundaries. Ideally, tasks are independent activities: work that doesn’t depend on the state, result, or side effects of other tasks.</p>
<p>Applications should exhibit good throughput, good responsiveness and a graceful degradation as they become overloaded, rather than simply falling over under heavy load. Choosing good task boundaries, coupled with a sensible task execution policy, can help achieve these goals.</p>
<h3 id="executing-tasks-sequentially">Executing tasks sequentially</h3>
<p>There are a number of possible policies for scheduling tasks within an application, some of which exploit the potential for concurrency better than others. The simplest is to execute tasks sequentially in a single thread. In some situations, sequential processing may offer a simplicity or safety advantage; most GUI frameworks process tasks sequentially using a single thread. In server applications, sequential processing rarely provides either good throughput or good responsiveness.</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingleThreadWebServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ServerSocket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">80</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Socket</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
            <span class="n">handleRequest</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">handleRequest</span><span class="o">(</span><span class="n">Socket</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// request-handling logic here</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3 id="explicitly-creating-threads-for-tasks">Explicitly creating threads for tasks</h3>
<p>A more responsive approach is to create a new thread for servicing each request, as shown in <code>ThreadPerTaskWebServer</code></p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPerTaskWebServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ServerSocket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">80</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">Socket</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
            <span class="n">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">handleRequest</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">};</span>
            <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">task</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">handleRequest</span><span class="o">(</span><span class="n">Socket</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// request-handling logic here</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p><code>ThreadPerTaskWebServer</code> is similar in structure to the single-threaded version—the main thread still alternates between accepting an incoming connection and dispatching the request. The difference is that for each connection, the main loop creates a new thread to process the request instead of processing it within the main thread. This has three main consequences:</p>
<ul>
<li>
<p>Task processing is offloaded from the main thread, enabling the main loop to resume waiting for the next incoming connection more quickly. This enables new connections to be accepted before previous requests complete, improving responsiveness.</p>
</li>
<li>
<p>Tasks can be processed in parallel, enabling multiple requests to be serviced simultaneously. This may improve throughput if there are multiple processors, or if tasks need to block for any reason such as I/O completion, lock acquisition, or resource availability.</p>
</li>
<li>
<p>Task-handling code must be thread-safe, because it may be invoked concurrently for multiple tasks.</p>
</li>
</ul>
<p>Under light to moderate load, the thread-per-task approach is an improvement over sequential execution. As long as the request arrival rate does not exceed the server’s capacity to handle requests, this approach offers better responsiveness and throughput.</p>
<h3 id="disadvantages-of-unbounded-thread-creation">Disadvantages of unbounded thread creation</h3>
<p>For production use, however, the thread-per-task approach has some practical drawbacks, especially when a large number of threads may be created:</p>
<ul>
<li>
<p><em><strong>Thread lifecycle overhead.</strong></em> Thread creation and teardown are not free. The actual overhead varies across platforms, but thread creation takes time, introducing latency into request processing, and requires some processing activity by the JVM and OS. If requests are frequent and lightweight, as in most server applications, creating a new thread for each request can consume significant computing resources.</p>
</li>
<li>
<p><em><strong>Resource consumption.</strong></em> Active threads consume system resources, especially memory. When there are more runnable threads than available processors, threads sit idle. Having many idle threads can tie up a lot of memory, putting pressure on the garbage collector, and having many threads competing for the CPUs can impose other performance costs as well. If you have enough threads to keep all the CPUs busy, creating more threads won’t help and may even hurt.</p>
</li>
<li>
<p><em><strong>Stability.</strong></em> There is a limit on how many threads can be created. The limit varies by platform and is affected by factors including JVM invocation parameters, the requested stack size in the Thread constructor, and limits on threads placed by the underlying operating system. When you hit this limit, the most likely result is an OutOfMemoryError. Trying to recover from such an error is very risky; it is far easier to structure your program to avoid hitting this limit.</p>
</li>
</ul>
<p>The way to stay out of danger is to place some bound on how many threads your application creates, and to test your application thoroughly to ensure that, even when this bound is reached, it does not run out of resources.</p>
<p>Like other concurrency hazards, unbounded thread creation may appear to work just fine during prototyping and development, with problems surfacing only when the application is deployed and under heavy load. <em><strong>So a malicious user, or enough ordinary users, can make your web server crash if the traffic load ever reaches a certain threshold. For a server application that is supposed to provide high availability and graceful degradation under load, this is a serious failing.</strong></em></p>
<h2 id="the-executor-framework">The Executor framework</h2>
<p><em><strong>Tasks are logical units of work, and threads are a mechanism by which tasks can run asynchronously.</strong></em> We’ve examined two policies for executing tasks using threads—execute tasks sequentially in a single thread, and execute each task in its own thread. Both have serious limitations: <em><strong>the sequential approach suffers from poor responsiveness and throughput, and the thread-per-task approach suffers from poor resource management.</strong></em></p>
<p>Thread pools offer the same benefit for thread management, and <code>java.util.concurrent</code> provides a flexible thread pool implementation as part of the Executor framework. The primary abstraction for task execution in the Java class libraries is not <code>Thread</code>, but <code>Executor</code>.</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Executor</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">command</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p><code>Executor</code> may be a simple interface, but it forms the basis for a flexible and powerful framework for asynchronous task execution that supports a wide variety of task execution policies. <em><strong>It provides a standard means of decoupling task submission from task execution</strong></em>, describing tasks with <code>Runnable</code>. The <code>Executor</code> implementations also provide lifecycle support and hooks for adding statistics gathering, application management, and monitoring.</p>
<p><code>Executor</code> is based on the producer-consumer pattern, where activities that submit tasks are the producers (producing units of work to be done) and the threads that execute tasks are the consumers (consuming those units of work). Using an <code>Executor</code> is usually the easiest path to implementing a producer-consumer design in your application.</p>
<h3 id="example-web-server-using-executor">Example: web server using Executor</h3>
<p>In <code>TaskExecutionWebServer</code>, submission of the request-handling task is decoupled from its execution using an <code>Executor</code>, and its behavior can be changed merely by substituting a different <code>Executor</code> implementation.</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TaskExecutionWebServer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NTHREADS</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Executor</span> <span class="n">exec</span>
            <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">NTHREADS</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ServerSocket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">80</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">Socket</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
            <span class="n">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">handleRequest</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">};</span>
            <span class="n">exec</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">handleRequest</span><span class="o">(</span><span class="n">Socket</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// request-handling logic here</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3 id="execution-policies">Execution policies</h3>
<p>The value of decoupling submission from execution is that it lets you easily specify, and subsequently change without great difficulty, the execution policy for a given class of tasks. <em><strong>An execution policy specifies the “what, where, when, and how” of task execution</strong></em>, including:</p>
<ul>
<li>In what thread will tasks be executed?</li>
<li>In what order should tasks be executed (FIFO, LIFO, priority order)?</li>
<li>How many tasks may execute concurrently?</li>
<li>How many tasks may be queued pending execution?</li>
<li>If a task has to be rejected because the system is overloaded, which task should be selected as the victim, and how should the application be notified?</li>
<li>What actions should be taken before or after executing a task?</li>
</ul>
<p><em><strong>Execution policies are a resource management tool, and the optimal policy depends on the available computing resources and your quality-of-service requirements. By limiting the number of concurrent tasks, you can ensure that the application does not fail due to resource exhaustion or suffer performance problems due to contention for scarce resources.</strong></em> Separating the specification of execution policy from task submission makes it practical to select an execution policy at deployment time that is matched to the available hardware.</p>
<blockquote>
<p>Whenever you see code of the form: <code>new Thread(runnable).start()</code> and you think you might at some point want a more flexible execution policy, seriously consider replacing it with the use of an Executor.</p>
</blockquote>
<h3 id="thread-pools">Thread pools</h3>
<p>A thread pool, as its name suggests, manages a homogeneous pool of worker threads. A thread pool is tightly bound to a work queue holding tasks waiting to be executed. Worker threads have a simple life: request the next task from the work queue, execute it, and go back to waiting for another task.</p>
<p>Reusing an existing thread instead of creating a new one amortizes thread creation and teardown costs over multiple requests. As an added bonus, since the worker thread often already exists at the time the request arrives, the latency associated with thread creation does not delay task execution, thus improving responsiveness. By properly tuning the size of the thread pool, you can have enough threads to keep the processors busy while not having so many that your application runs out of memory or thrashes due to competition among threads for resources.</p>
<p>The class library provides a flexible thread pool implementation along with some useful predefined configurations. You can create a thread pool by calling one of the static factory methods in Executors:</p>
<ul>
<li>
<p><em><strong><code>newFixedThreadPool</code></strong></em> A fixed-size thread pool creates threads as tasks are sub- mitted, up to the maximum pool size, and then attempts to keep the pool size constant (adding new threads if a thread dies due to an unexpected <code>Exception</code>).</p>
</li>
<li>
<p><em><strong><code>newCachedThreadPool</code></strong></em> A cached thread pool has more flexibility to reap idle threads when the current size of the pool exceeds the demand for processing, and to add new threads when demand increases, but places no bounds on the size of the pool.</p>
</li>
<li>
<p><em><strong><code>newSingleThreadExecutor</code></strong></em> A single-threaded executor creates a single worker thread to process tasks, replacing it if it dies unexpectedly. Tasks are guaranteed to be processed sequentially according to the order imposed by the task queue (FIFO, LIFO, priority order).</p>
</li>
<li>
<p><em><strong><code>newScheduledThreadPool</code></strong></em> A fixed-size thread pool that supports delayed and periodic task execution, similar to <code>Timer</code>.</p>
</li>
</ul>
<p>The <code>newFixedThreadPool</code> and <code>newCachedThreadPool</code> factories return instances of the general-purpose <code>ThreadPoolExecutor</code>, which can also be used directly to construct more specialized executors.</p>
<p>Switching from a thread-per-task policy to a pool-based policy has a big effect on application stability: the web server will no longer fail under heavy load.</p>
<p>It also degrades more gracefully, since it does not create thousands of threads that compete for limited CPU and memory resources. And using an Executor opens the door to all sorts of additional opportunities for tuning, management, monitoring, logging, error reporting, and other possibilities that would have been far more difficult to add without a task execution framework.</p>
<h3 id="executor-lifecycle">Executor lifecycle</h3>
<p>An <code>Executor</code> implementation is likely to create threads for processing tasks. But the <em><strong>JVM can’t exit until all the (nondaemon) threads have terminated, so failing to shut down an Executor could prevent the JVM from exiting.</strong></em></p>
<p>Because an <code>Executor</code> processes tasks asynchronously, at any given time the state of previously submitted tasks is not immediately obvious. Some may have completed, some may be currently running, and others may be queued awaiting execution. In shutting down an application, there is a spectrum from graceful shutdown (finish what you’ve started but don’t accept any new work) to abrupt shutdown (turn off the power to the machine room), and various points in between.</p>
<p>Since <code>Executors</code> provide a service to applications, they should be able to be shut down as well, both gracefully and abruptly, and feed back information to the application about the status of tasks that were affected by the shutdown. To address the issue of execution service lifecycle, the <code>ExecutorService</code> interface extends <code>Executor</code>, adding a number of methods for lifecycle management (as well as some convenience methods for task submission).</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExecutorService</span> <span class="kd">extends</span> <span class="n">Executor</span> <span class="o">{</span> 
  <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">();</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="nf">shutdownNow</span><span class="o">();</span>
  <span class="kt">boolean</span> <span class="nf">isShutdown</span><span class="o">();</span>
  <span class="kt">boolean</span> <span class="nf">isTerminated</span><span class="o">();</span>
  <span class="kt">boolean</span> <span class="nf">awaitTermination</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
  <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
  <span class="c1">// ... additional convenience methods for task submission</span>
<span class="o">}</span>
</pre></div>


<p>The lifecycle implied by <code>ExecutorService</code> has three states—running, shutting down, and terminated. <code>ExecutorServices</code> are initially created in the running state. The shutdown method initiates a graceful shutdown: no new tasks are accepted but previously submitted tasks are allowed to complete—including those that have not yet begun execution. The <code>shutdownNow</code> method initiates an abrupt shutdown: it attempts to cancel outstanding tasks and does not start any tasks that are queued but not begun.</p>
<p>Tasks submitted to an <code>ExecutorService</code> after it has been shut down are handled by the rejected execution handler, which might silently discard the task or might cause execute to throw the unchecked <code>RejectedExecutionException</code>. Once all tasks have completed, the <code>ExecutorService</code> transitions to the terminated state. You can wait for an <code>ExecutorService</code> to reach the terminated state with <code>awaitTermination</code>, or poll for whether it has yet terminated with <code>isTerminated</code>. It is common to follow shutdown immediately by <code>awaitTermination</code>, creating the effect of synchronously shutting down the <code>ExecutorService</code>.</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LifecycleWebServer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ExecutorService</span> <span class="n">exec</span> <span class="o">=</span> <span class="o">...;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ServerSocket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">80</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">exec</span><span class="o">.</span><span class="na">isShutdown</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="n">Socket</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
                <span class="n">exec</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                        <span class="n">handleRequest</span><span class="o">(</span><span class="n">conn</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RejectedExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">exec</span><span class="o">.</span><span class="na">isShutdown</span><span class="o">())</span>
                    <span class="n">log</span><span class="o">(</span><span class="s">&quot;task submission rejected&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">exec</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">handleRequest</span><span class="o">(</span><span class="n">Socket</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Request</span> <span class="n">req</span> <span class="o">=</span> <span class="n">readRequest</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isShutdownRequest</span><span class="o">(</span><span class="n">req</span><span class="o">))</span>
            <span class="n">stop</span><span class="o">();</span>
        <span class="k">else</span>
            <span class="n">dispatchRequest</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3 id="delayed-and-periodic-tasks">Delayed and periodic tasks</h3>
<p>The <code>Timer</code> facility manages the execution of deferred (“run this task in 100 ms”) and periodic (“run this task every 10 ms”) tasks. However, Timer has some drawbacks, and <code>ScheduledThreadPoolExecutor</code> should be thought of as its replacement.</p>
<p>A <code>Timer</code> creates only a single thread for executing timer tasks. If a timer task takes too long to run, the timing accuracy of other <code>TimerTasks</code> can suffer. If a recurring <code>TimerTask</code> is scheduled to run every 10 ms and another <code>TimerTask</code> takes 40 ms to run, the recurring task either (depending on whether it was scheduled at fixed rate or fixed delay) gets called four times in rapid succession after the long-running task completes, or “misses” four invocations completely. Scheduled thread pools address this limitation by letting you provide multiple threads for executing deferred and periodic tasks.
Another problem with <code>Timer</code> is that it behaves poorly if a <code>TimerTask</code> throws an unchecked exception. The <code>Timer</code> thread doesn’t catch the exception, so an unchecked exception thrown from a <code>TimerTask</code> terminates the timer thread. <code>Timer</code> also doesn’t resurrect the thread in this situation; instead, it erroneously assumes the entire <code>Timer</code> was cancelled.</p>
<h2 id="finding-exploitable-parallelism">Finding exploitable parallelism</h2>
<p>The <code>Executor</code> framework makes it easy to specify an execution policy, but in order to use an <code>Executor</code>, you have to be able to describe your task as a <code>Runnable</code>. In most server applications, there is an obvious task boundary: a single client request. But sometimes good task boundaries are not quite so obvious, as in many desktop applications.</p>
<h3 id="example-sequential-page-renderer">Example: sequential page renderer</h3>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SingleThreadRenderer</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">renderPage</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">renderText</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;</span> <span class="n">imageData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ImageInfo</span> <span class="n">imageInfo</span> <span class="o">:</span> <span class="n">scanForImageInfo</span><span class="o">(</span><span class="n">source</span><span class="o">))</span>
            <span class="n">imageData</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">imageInfo</span><span class="o">.</span><span class="na">downloadImage</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ImageData</span> <span class="n">data</span> <span class="o">:</span> <span class="n">imageData</span><span class="o">)</span>
            <span class="n">renderImage</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3 id="result-bearing-tasks-callable-and-future">Result-bearing tasks: <code>Callable</code> and <code>Future</code></h3>
<p>The <code>Executor</code> framework uses Runnable as its basic task representation. <code>Runnable</code> is a fairly limiting abstraction; <em><strong>run cannot return a value or throw checked exceptions, although it can have side effects such as writing to a log file or placing a result in a shared data structure.</strong></em></p>
<p>Many tasks are effectively deferred computations—executing a database query, fetching a resource over the network, or computing a complicated function. For these types of tasks, <code>Callable</code> is a better abstraction: <em><strong>it expects that the main entry point, call, will return a value and anticipates that it might throw an exception.</strong></em> <code>Executors</code> includes several utility methods for wrapping other types of tasks, including <code>Runnable</code> and <code>java.security.PrivilegedAction</code>, with a <code>Callable</code>.</p>
<p>The lifecycle of a task executed by an <code>Executor</code> has four phases: created, submitted, started, and completed. Since tasks can take a long time to run, we also want to be able to cancel a task. In the <code>Executor</code> framework, tasks that have been submitted but not yet started can always be cancelled, and tasks that have started can sometimes be cancelled if they are responsive to interruption. Cancelling a task that has already completed has no effect.</p>
<p><code>Future</code> represents the lifecycle of a task and provides methods to test whether the task has completed or been cancelled, retrieve its result, and cancel the task. Implicit in the specification of <code>Future</code> is that task lifecycle can only move forwards, not backwards—just like the ExecutorService lifecycle. Once a task is completed, it stays in that state forever.
The behavior of <code>get</code> varies depending on the task state (not yet started, running, completed). It returns immediately or throws an <code>Exception</code> if the task has already completed, but if not it blocks until the task completes. If the task completes by throwing an exception, get rethrows it wrapped in an <code>ExecutionException</code>; if it was cancelled, <code>get</code> throws <code>CancellationException</code>. If <code>get</code> throws <code>ExecutionException</code>, the underlying exception can be retrieved with <code>getCause</code>.</p>
<p>There are several ways to create a <code>Future</code> to describe a task. The submit methods in <code>ExecutorService</code> all return a <code>Future</code>, so that you can submit a <code>Runnable</code> or a <code>Callable</code> to an executor and get back a <code>Future</code> that can be used to retrieve the result or cancel the task. You can also explicitly instantiate a <code>FutureTask</code> for a given <code>Runnable</code> or <code>Callable</code>. (Because <code>FutureTask</code> implements <code>Runnable</code>, it can be submitted to an <code>Executor</code> for execution or executed directly by calling its <code>run</code> method.)</p>
<p>Submitting a <code>Runnable</code> or <code>Callable</code> to an <code>Executor</code> constitutes a safe publication of the <code>Runnable</code> or <code>Callable</code> from the submitting thread to the thread that will eventually execute the task. Similarly, setting the result value for a Future constitutes a safe publication of the result from the thread in which it was computed to any thread that retrieves it via <code>get</code>.</p>
<h3 id="example-page-renderer-with-future">Example: page renderer with Future</h3>
<p><code>FutureRenderer</code> allows the text to be rendered concurrently with downloading the image data. When all the images are downloaded, they are rendered onto the page. This is an improvement in that the user sees a result quickly and it exploits some parallelism, but we can do considerably better. There is no need for users to wait for all the images to be downloaded; they would probably prefer to see individual images drawn as they become available.</p>
<p>The state-dependent nature of get means that the caller need not be aware of the state of the task, and the safe publication properties of task submission and result retrieval make this approach thread-safe. The exception handling code surrounding Future.get deals with two possible problems: that the task encountered an Exception, or the thread calling get was interrupted before the results were available.</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">FutureRenderer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>

    <span class="kt">void</span> <span class="nf">renderPage</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ImageInfo</span><span class="o">&gt;</span> <span class="n">imageInfos</span> <span class="o">=</span> <span class="n">scanForImageInfo</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="n">Callable</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;&gt;</span> <span class="n">task</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
                    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
                        <span class="n">List</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;();</span>
                        <span class="k">for</span> <span class="o">(</span><span class="n">ImageInfo</span> <span class="n">imageInfo</span> <span class="o">:</span> <span class="n">imageInfos</span><span class="o">)</span>
                            <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">imageInfo</span><span class="o">.</span><span class="na">downloadImage</span><span class="o">());</span>
                        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">};</span>

        <span class="n">Future</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="n">renderText</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;</span> <span class="n">imageData</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">ImageData</span> <span class="n">data</span> <span class="o">:</span> <span class="n">imageData</span><span class="o">)</span>
                <span class="n">renderImage</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Re-assert the thread&#39;s interrupted status</span>
            <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="c1">// We don&#39;t need the result, so cancel the task too</span>
            <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">launderThrowable</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3 id="limitations-of-parallelizing-heterogeneous-tasks">Limitations of parallelizing heterogeneous tasks</h3>
<p>Two people can divide the work of cleaning the dinner dishes fairly effectively: one person washes while the other dries. However, assigning a different type of task to each worker does not scale well; if several more people show up, it is not obvious how they can help without getting in the way or significantly restructuring the division of labor. Without finding finer-grained parallelism among similar tasks, this approach will yield diminishing returns.</p>
<p>A further problem with dividing heterogeneous tasks among multiple workers is that the tasks may have disparate sizes. If you divide tasks A and B between two workers but A takes ten times as long as B, you’ve only speeded up the total process by 9%. Finally, dividing a task among multiple workers always involves some amount of coordination overhead; for the division to be worthwhile, this overhead must be more than compensated by productivity improvements due to parallelism.</p>
<blockquote>
<p>The real performance payoff of dividing a program’s workload into tasks comes when there are a large number of independent, homogeneous tasks that can be processed concurrently.</p>
</blockquote>
<h3 id="completionservice-executor-meets-blockingqueue"><code>CompletionService</code>: <code>Executor</code> meets <code>BlockingQueue</code></h3>
<p>If you have a batch of computations to submit to an <code>Executor</code> and you want to retrieve their results as they become available, you could retain the <code>Future</code> associated with each task and repeatedly poll for completion by calling <code>get</code> with a timeout of zero. This is possible, but tedious. Fortunately there is a better way: a completion service.</p>
<p><code>CompletionService</code> combines the functionality of an <code>Executor</code> and a <code>BlockingQueue</code>. You can submit <code>Callable</code> tasks to it for execution and use the queue-like methods take and poll to retrieve completed results, packaged as <code>Futures</code>, as they become available. <code>ExecutorCompletionService</code> implements <code>CompletionService</code>, delegating the computation to an Executor.</p>
<p>The implementation of <code>ExecutorCompletionService</code> is quite straightforward. The constructor creates a <code>BlockingQueue</code> to hold the completed results. <code>FutureTask</code> has a done method that is called when the computation completes. When a task is submitted, it is wrapped with a <code>QueueingFuture</code>, a subclass of <code>FutureTask</code> that overrides done to place the result on the <code>BlockingQueue</code>, as shown below:</p>
<div class="codehilite"><pre><span></span><span class="kd">private</span> <span class="kd">class</span> <span class="nc">QueueingFuture</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span> 
  <span class="n">QueueingFuture</span><span class="o">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">c</span><span class="o">);</span> <span class="o">}</span> 
  <span class="n">QueueingFuture</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">t</span><span class="o">,</span> <span class="n">V</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span> <span class="o">}</span>

  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">done</span><span class="o">()</span> <span class="o">{</span> 
    <span class="n">completionQueue</span> <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span> 
<span class="o">}</span>
</pre></div>


<p>(<code>QueueingFuture</code> class used by <code>ExecutorCompletionService</code>)</p>
<h3 id="example-page-renderer-with-completionservice">Example: page renderer with <code>CompletionService</code></h3>
<p>We can use a <code>CompletionService</code> to improve the performance of the page renderer in two ways: shorter total runtime and improved responsiveness. We can create a separate task for downloading each image and execute them in a thread pool, turning the sequential download into a parallel one: this reduces the amount of time to download all the images. And by fetching results from the <code>CompletionService</code> and rendering each image as soon as it is available, we can give the user a more dynamic and responsive user interface.</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Renderer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ExecutorService</span> <span class="n">executor</span><span class="o">;</span>

    <span class="n">Renderer</span><span class="o">(</span><span class="n">ExecutorService</span> <span class="n">executor</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">executor</span> <span class="o">=</span> <span class="n">executor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">renderPage</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ImageInfo</span><span class="o">&gt;</span> <span class="n">info</span> <span class="o">=</span> <span class="n">scanForImageInfo</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="n">CompletionService</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;</span> <span class="n">completionService</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">ExecutorCompletionService</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;(</span><span class="n">executor</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="n">ImageInfo</span> <span class="n">imageInfo</span> <span class="o">:</span> <span class="n">info</span><span class="o">)</span>
            <span class="n">completionService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="kd">public</span> <span class="n">ImageData</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">imageInfo</span><span class="o">.</span><span class="na">downloadImage</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>

        <span class="n">renderText</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">t</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">Future</span><span class="o">&lt;</span><span class="n">ImageData</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">completionService</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
                <span class="n">ImageData</span> <span class="n">imageData</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                <span class="n">renderImage</span><span class="o">(</span><span class="n">imageData</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">launderThrowable</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Multiple <code>ExecutorCompletionServices</code> can share a single Executor, so it is perfectly sensible to create an <code>ExecutorCompletionService</code> that is private to a particular computation while sharing a common Executor. When used in this way, a <code>CompletionService</code> acts as a handle for a batch of computations in much the same way that a Future acts as a handle for a single computation. By remembering how many tasks were submitted to the <code>CompletionService</code> and counting how many completed results are retrieved, you can know when all the results for a given batch have been retrieved, even if you use a shared Executor.</p>
<h3 id="placing-time-limits-on-tasks">Placing time limits on tasks</h3>
<p>Sometimes, if an activity does not complete within a certain amount of time, the result is no longer needed and the activity can be abandoned. For example, a web application may fetch its advertisements from an external ad server, but if the ad is not available within two seconds, it instead displays a default advertisement so that ad unavailability does not undermine the site’s responsiveness requirements. Similarly, a portal site may fetch data in parallel from multiple data sources, but may be willing to wait only a certain amount of time for data to be available before rendering the page without it.</p>
<p>The primary challenge in executing tasks within a time budget is making sure that you don’t wait longer than the time budget to get an answer or find out that one is not forthcoming. The timed version of <code>Future.get</code> supports this requirement: it returns as soon as the result is ready, but throws TimeoutException if the result is not ready within the timeout period.</p>
<p>A secondary problem when using timed tasks is to stop them when they run out of time, so they do not waste computing resources by continuing to compute a result that will not be used. This can be accomplished by having the task strictly manage its own time budget and abort if it runs out of time, or by cancelling the task if the timeout expires. Again, <code>Future</code> can help; if a timed <code>get</code> completes with a <code>TimeoutException</code>, you can cancel the task through the <code>Future</code>. If the task is written to be cancellable, it can be terminated early so as not to consume excessive resources.</p>
<p>Listing below shows a typical application of a timed <code>Future.get</code>. It generates a composite web page that contains the requested content plus an advertisement fetched from an ad server. It submits the ad-fetching task to an executor, computes the rest of the page content, and then waits for the ad until its time budget runs out. If the <code>get</code> times out<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>, it cancels<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup> the ad-fetching task and uses a default advertisement instead.</p>
<div class="codehilite"><pre><span></span>    <span class="n">Page</span> <span class="nf">renderPageWithAd</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">endNanos</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">TIME_BUDGET</span><span class="o">;</span>
        <span class="n">Future</span><span class="o">&lt;</span><span class="n">Ad</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">exec</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="n">FetchAdTask</span><span class="o">());</span>
        <span class="c1">// Render the page while waiting for the ad</span>
        <span class="n">Page</span> <span class="n">page</span> <span class="o">=</span> <span class="n">renderPageBody</span><span class="o">();</span>
        <span class="n">Ad</span> <span class="n">ad</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Only wait for the remaining time budget</span>
            <span class="kt">long</span> <span class="n">timeLeft</span> <span class="o">=</span> <span class="n">endNanos</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
            <span class="n">ad</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">timeLeft</span><span class="o">,</span> <span class="n">NANOSECONDS</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ad</span> <span class="o">=</span> <span class="n">DEFAULT_AD</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ad</span> <span class="o">=</span> <span class="n">DEFAULT_AD</span><span class="o">;</span>
            <span class="n">f</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">page</span><span class="o">.</span><span class="na">setAd</span><span class="o">(</span><span class="n">ad</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">page</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>


<h3 id="example-a-travel-reservations-portal">Example: a travel reservations portal</h3>
<p>Consider a travel reservation portal: the user enters travel dates and requirements and the portal fetches and displays bids from a number of airlines, hotels or car rental companies. Depending on the company, fetching a bid might involve invoking a web service, consulting a database, performing an EDI transaction, or some other mechanism. Rather than have the response time for the page be driven by the slowest response, it may be preferable to present only the information available within a given time budget. For providers that do not respond in time, the page could either omit them completely or display a placeholder such as “Did not hear from Air Java in time.”</p>
<p>Fetching a bid from one company is independent of fetching bids from another, so fetching a single bid is a sensible task boundary that allows bid retrieval to proceed concurrently. It would be easy enough to create n tasks, submit them to a thread pool, retain the Futures, and use a timed get to fetch each result sequentially via its Future, but there is an even easier way—<code>invokeAll</code>.</p>
<p>Below code uses the timed version of <code>invokeAll</code> to submit multiple tasks to an <code>ExecutorService</code> and retrieve the results. The <code>invokeAll</code> method takes a collection of tasks and returns a collection of Futures. The two collections have identical structures; <code>invokeAll</code> adds the Futures to the returned collection in the order imposed by the task collection’s iterator, thus allowing the caller to associate a <code>Future</code> with the <code>Callable</code> it represents. The timed version of <code>invokeAll</code> will return when all the tasks have completed, the calling thread is interrupted, or the timeout expires. Any tasks that are not complete when the timeout expires are cancelled. On return from <code>invokeAll</code>, each task will have either completed normally or been cancelled; the client code can call <code>get</code> or <code>isCancelled</code> to find out which.</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TimeBudget</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="n">exec</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TravelQuote</span><span class="o">&gt;</span> <span class="nf">getRankedTravelQuotes</span><span class="o">(</span><span class="n">TravelInfo</span> <span class="n">travelInfo</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">TravelCompany</span><span class="o">&gt;</span> <span class="n">companies</span><span class="o">,</span>
                                                   <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">TravelQuote</span><span class="o">&gt;</span> <span class="n">ranking</span><span class="o">,</span> <span class="kt">long</span> <span class="n">time</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">QuoteTask</span><span class="o">&gt;</span> <span class="n">tasks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">QuoteTask</span><span class="o">&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">TravelCompany</span> <span class="n">company</span> <span class="o">:</span> <span class="n">companies</span><span class="o">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">QuoteTask</span><span class="o">(</span><span class="n">company</span><span class="o">,</span> <span class="n">travelInfo</span><span class="o">));</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">TravelQuote</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="n">exec</span><span class="o">.</span><span class="na">invokeAll</span><span class="o">(</span><span class="n">tasks</span><span class="o">,</span> <span class="n">time</span><span class="o">,</span> <span class="n">unit</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">TravelQuote</span><span class="o">&gt;</span> <span class="n">quotes</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">TravelQuote</span><span class="o">&gt;(</span><span class="n">tasks</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">QuoteTask</span><span class="o">&gt;</span> <span class="n">taskIter</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">TravelQuote</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">QuoteTask</span> <span class="n">task</span> <span class="o">=</span> <span class="n">taskIter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">quotes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">quotes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getFailureQuote</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">()));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancellationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">quotes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getTimeoutQuote</span><span class="o">(</span><span class="n">e</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">quotes</span><span class="o">,</span> <span class="n">ranking</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">quotes</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

<span class="kd">class</span> <span class="nc">QuoteTask</span> <span class="kd">implements</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">TravelQuote</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TravelCompany</span> <span class="n">company</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TravelInfo</span> <span class="n">travelInfo</span><span class="o">;</span>
    <span class="c1">// ...</span>
    <span class="kd">public</span> <span class="n">TravelQuote</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">company</span><span class="o">.</span><span class="na">solicitQuote</span><span class="o">(</span><span class="n">travelInfo</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="summary">Summary</h2>
<p>Structuring applications around the execution of tasks can simplify development and facilitate concurrency. The <code>Executor</code> framework permits you to decouple task submission from execution policy and supports a rich variety of execution policies; whenever you find yourself creating threads to perform tasks, consider using an <code>Executor</code> instead. To maximize the benefit of decomposing an application into tasks, you must identify sensible task boundaries. In some applications, the obvious task boundaries work well, whereas in others some analysis may be required to uncover finer-grained exploitable parallelism.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>The timeout passed to get is computed by subtracting the current time from the deadline; this may in fact yield a negative number, but all the timed methods in <code>java.util.concurrent</code> treat negative timeouts as zero, so no extra code is needed to deal with this case..&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>The true parameter to <code>Future.cancel</code> means that the task thread can be interrupted if the task is currently running.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../fundamentals/summary/" title="Summary Part I" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Summary Part I
              </span>
            </div>
          </a>
        
        
          <a href="../c07-cancellation-and-shutdown/" title="Cancellation and Shutdown" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Cancellation and Shutdown
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.a353778b.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:"../../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>